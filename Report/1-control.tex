\section{Control algorithm}
The core of the controller is a simple proportional controller which has in input the magnetic field generated by the permanent magnet (which is assumed to be, for small movements, proportional to its position), and in output the magnetic field which must be generated by the electromagnet.

The main problem in using a single Hall-effect sensor placed under the electromagnet to read the position of the permanent magnet is that the sensor includes the coil's magnetic field, which thus must be filtered before being sent in input to the controller. To do this, a simple model of the coil as an RL circuit is used, having the digital output (0-1) of the sensor as an input and the coil's magnetic field as an output. Different units for each measure (time, magnetic field, etc.) are all proportional with respect to IS units. Hence, they can be absorbed into the proportional gain of the controller and thus units can be chosen arbitrarily to simplify the microcontroller's calculations without affecting the result. In particular:

\begin{itemize}
  \item{\emph{Time} is measured in \emph{ticks}, which correspond to the time distance between one ADC reading and the next ($10^{-4}s$). ADC readings are also used as a time base for the control loop. Thus, the time interval between each control loop is \emph{1 tick};}
  \item{\emph{Magnetic field} is measured in \emph{bits}, which correspond to 1 ADC bit. In order to keep this scale proportional to the read magnetic field in $G$, the base sensor value (measured once as a calibration constant) is always subtracted from the ADC reading and the resulting value is negated;}
  \item{\emph{Voltage} on the coil is measured as a digital value, which is 0 with the controlling transistor turned off ($0V$) and 1 with the same transistor turned on ($12V$);}
  \item{\emph{Current} into the coil is measured in \emph{value}, which is 0 when no current flows into the magnet and 1 when full current ($I=12/R_{coil}$) flows into it. Magnetic field of the coil is proportional to its \emph{value}.}
\end{itemize}

With these units, the coil's model obeys the usual laws of RL circuits (assuming I(0) is the starting current into the coil when the coil is turned on or off):
\[
    B(t)=B_{max}I(t)
\]

\[
  I(t) = \left\{
    \begin{array}{lr}
      I(0)e^{-\frac{t}{\tau}} & if V = 0 \\
      1-(1-I(0))e^{-\frac{t}{\tau}} & if V = 1.
    \end{array} 
  \right.
\]


Discratization of these formulas at time steps of $1tick$ brings to the following:
\[
  \begin{array}{c}
  \Delta I(t) = I(t) - I(t-1) = \left\{
    \begin{array}{lr}
      I(t-1)(e^{\frac{-1}{\tau}}-1) & if V(t-1) = 0 \\
      (1-I(t-1))(1-e^{\frac{-1}{\tau}}) & if V(t-1) = 1
    \end{array}
  \right. \\
  \Downarrow \\
  I(t) = \left\{
    \begin{array}{lr}
      I(t-1)+DI(t-1) & if V(t-1) = 0 \\
      I(t-1)+U(1-I(t-1)) & if V(t-1) = 1
    \end{array}
  \right.
  \end{array}
\]

$D$ and $U$ are the charging and discharging rates of the coil, and, after measuring $\tau$ as the time taken for the coil to reach 63\% of its current's swing, can be approximated using McLaurin's series:

\[
  \begin{array}{c}
    D=-1+e^{\frac{-1}{\tau}}=-1+\frac{1}{1+\frac{1}{\tau}+\frac{1}{2\tau^2}} \\
    U=1-e^{\frac{-1}{\tau}}=1-\frac{1}{1+\frac{1}{\tau}+\frac{1}{2\tau^2}}
  \end{array}
\]

So, at each control step, the magnetic field is read from the sensor, and to it the simulated coil's field $B_{max}I(t)$ is subtracted. The remaining value indicates the position of the permanent magnet, which can thus be controlled. If the output of the controller is higher than the current coil's field, the coil is turned on. Otherwise, the coil is turned off.

In practice, this means that the coil acts as an integrator and sees as an input the pulses from the microcontroller. The circuit thus acts as a Delta-Sigma DAC: the microcontroller sends pulses of fixed width of $10^(-4) s$, each pulse being 0 or 1 depending on whether the desired reference (analog) signal to apply to the coil is, at each time instant, higher or lower than the integrator's (i.e. the coil's) actual output value. The feedback for this DAC, i.e. the output of the coil, is not measured but simulated from the microcontroller.

